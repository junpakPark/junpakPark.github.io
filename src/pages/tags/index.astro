---
import {getCollection, type CollectionEntry} from "astro:content";
import {processPosts} from "../../utils";

import TagList from "../../components/TagList";
import BaseLayout from "../../layouts/BaseLayout.astro";
import MainLayout from "../../layouts/MainLayout.astro";


type TagCounts = {
    [tag: string]: number;
};

const countTags = (posts: CollectionEntry<"blog">[]): TagCounts =>
    posts.reduce((acc: TagCounts, post) => {
        post.data.tags.forEach(tag => {
            acc[tag] = (acc[tag] || 0) + 1;
        });
        return acc;
    }, {});

const getTags = async (): Promise<{
    allTags: string[];
    tagCounts: TagCounts;
}> => {
    const allPosts: CollectionEntry<"blog">[] = await getCollection("blog");
    const processedPosts = processPosts(allPosts);

    const tagCounts = countTags(processedPosts);
    const allTags = Object.keys(tagCounts).sort(
        (a, b) => tagCounts[b] - tagCounts[a]
    );

    return {allTags, tagCounts};
};

const {allTags, tagCounts} = await getTags();
---

<BaseLayout>
    <MainLayout>
        <div class="flex justify-around">
            <article class="mx-auto md:w-[48rem] p-[4rem] space-y-4">
                <h1 class="text-2xl font-semibold">
                    There are <span class="text-purple-600">{allTags.length}</span> tags!
                </h1>
                <TagList tags={allTags} tagCounts={tagCounts}/>
                <hr/>
            </article>
        </div>
    </MainLayout>
</BaseLayout>
